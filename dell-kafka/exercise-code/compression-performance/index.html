<!DOCTYPE html>

<html>
	<head>
		<style>
			.markdown-body {
				box-sizing: border-box;
				min-width: 200px;
				max-width: 80%;
				margin: 0 auto 51px auto;
				padding: 45px;
				border:1px solid rgba(27,31,35,0.15);
				border-radius:0 0 3px 3px;
			}

			@media (max-width: 80%) {
				.markdown-body {
					padding: 15px;
				}
			}

			.top-bar {
				box-sizing: border-box;
				min-width: 200px;
				max-width: 80%;
				background-color: #f6f8fa;
				border:1px solid rgba(27,31,35,0.15);
				border-radius:3px 3px 0 0;
				border-style: solid solid none;
				margin: 64px auto 0;
				width: 100%;
				padding: 9px;
				font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
				font-weight: bold;
				font-size: 85%;
}

			.file-name {
				margin-left: 22px;
			}

			
@font-face {
  font-family: octicons-link;
  src: url(data:font/woff;charset=utf-8;base64,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) format('woff');
}

.markdown-body {
  -ms-text-size-adjust: 100%;
  -webkit-text-size-adjust: 100%;
  line-height: 1.5;
  color: #24292e;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
  font-size: 16px;
  line-height: 1.5;
  word-wrap: break-word;
}

.markdown-body .pl-c {
  color: #6a737d;
}

.markdown-body .pl-c1,
.markdown-body .pl-s .pl-v {
  color: #005cc5;
}

.markdown-body .pl-e,
.markdown-body .pl-en {
  color: #6f42c1;
}

.markdown-body .pl-smi,
.markdown-body .pl-s .pl-s1 {
  color: #24292e;
}

.markdown-body .pl-ent {
  color: #22863a;
}

.markdown-body .pl-k {
  color: #d73a49;
}

.markdown-body .pl-s,
.markdown-body .pl-pds,
.markdown-body .pl-s .pl-pse .pl-s1,
.markdown-body .pl-sr,
.markdown-body .pl-sr .pl-cce,
.markdown-body .pl-sr .pl-sre,
.markdown-body .pl-sr .pl-sra {
  color: #032f62;
}

.markdown-body .pl-v,
.markdown-body .pl-smw {
  color: #e36209;
}

.markdown-body .pl-bu {
  color: #b31d28;
}

.markdown-body .pl-ii {
  color: #fafbfc;
  background-color: #b31d28;
}

.markdown-body .pl-c2 {
  color: #fafbfc;
  background-color: #d73a49;
}

.markdown-body .pl-c2::before {
  content: "^M";
}

.markdown-body .pl-sr .pl-cce {
  font-weight: bold;
  color: #22863a;
}

.markdown-body .pl-ml {
  color: #735c0f;
}

.markdown-body .pl-mh,
.markdown-body .pl-mh .pl-en,
.markdown-body .pl-ms {
  font-weight: bold;
  color: #005cc5;
}

.markdown-body .pl-mi {
  font-style: italic;
  color: #24292e;
}

.markdown-body .pl-mb {
  font-weight: bold;
  color: #24292e;
}

.markdown-body .pl-md {
  color: #b31d28;
  background-color: #ffeef0;
}

.markdown-body .pl-mi1 {
  color: #22863a;
  background-color: #f0fff4;
}

.markdown-body .pl-mc {
  color: #e36209;
  background-color: #ffebda;
}

.markdown-body .pl-mi2 {
  color: #f6f8fa;
  background-color: #005cc5;
}

.markdown-body .pl-mdr {
  font-weight: bold;
  color: #6f42c1;
}

.markdown-body .pl-ba {
  color: #586069;
}

.markdown-body .pl-sg {
  color: #959da5;
}

.markdown-body .pl-corl {
  text-decoration: underline;
  color: #032f62;
}

.markdown-body .octicon {
  display: inline-block;
  vertical-align: text-top;
  fill: currentColor;
}

.markdown-body a {
  background-color: transparent;
}

.markdown-body a:active,
.markdown-body a:hover {
  outline-width: 0;
}

.markdown-body strong {
  font-weight: inherit;
}

.markdown-body strong {
  font-weight: bolder;
}

.markdown-body h1 {
  font-size: 2em;
  margin: 0.67em 0;
}

.markdown-body img {
  border-style: none;
}

.markdown-body code,
.markdown-body kbd,
.markdown-body pre {
  font-family: monospace, monospace;
  font-size: 1em;
}

.markdown-body hr {
  box-sizing: content-box;
  height: 0;
  overflow: visible;
}

.markdown-body input {
  font: inherit;
  margin: 0;
}

.markdown-body input {
  overflow: visible;
}

.markdown-body [type="checkbox"] {
  box-sizing: border-box;
  padding: 0;
}

.markdown-body * {
  box-sizing: border-box;
}

.markdown-body input {
  font-family: inherit;
  font-size: inherit;
  line-height: inherit;
}

.markdown-body a {
  color: #0366d6;
  text-decoration: none;
}

.markdown-body a:hover {
  text-decoration: underline;
}

.markdown-body strong {
  font-weight: 600;
}

.markdown-body hr {
  height: 0;
  margin: 15px 0;
  overflow: hidden;
  background: transparent;
  border: 0;
  border-bottom: 1px solid #dfe2e5;
}

.markdown-body hr::before {
  display: table;
  content: "";
}

.markdown-body hr::after {
  display: table;
  clear: both;
  content: "";
}

.markdown-body table {
  border-spacing: 0;
  border-collapse: collapse;
}

.markdown-body td,
.markdown-body th {
  padding: 0;
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body h1 {
  font-size: 32px;
  font-weight: 600;
}

.markdown-body h2 {
  font-size: 24px;
  font-weight: 600;
}

.markdown-body h3 {
  font-size: 20px;
  font-weight: 600;
}

.markdown-body h4 {
  font-size: 16px;
  font-weight: 600;
}

.markdown-body h5 {
  font-size: 14px;
  font-weight: 600;
}

.markdown-body h6 {
  font-size: 12px;
  font-weight: 600;
}

.markdown-body p {
  margin-top: 0;
  margin-bottom: 10px;
}

.markdown-body blockquote {
  margin: 0;
}

.markdown-body ul,
.markdown-body ol {
  padding-left: 0;
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body ol ol,
.markdown-body ul ol {
  list-style-type: lower-roman;
}

.markdown-body ul ul ol,
.markdown-body ul ol ol,
.markdown-body ol ul ol,
.markdown-body ol ol ol {
  list-style-type: lower-alpha;
}

.markdown-body dd {
  margin-left: 0;
}

.markdown-body code {
  font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
  font-size: 12px;
}

.markdown-body pre {
  margin-top: 0;
  margin-bottom: 0;
  font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
  font-size: 12px;
}

.markdown-body .octicon {
  vertical-align: text-bottom;
}

.markdown-body .pl-0 {
  padding-left: 0 !important;
}

.markdown-body .pl-1 {
  padding-left: 4px !important;
}

.markdown-body .pl-2 {
  padding-left: 8px !important;
}

.markdown-body .pl-3 {
  padding-left: 16px !important;
}

.markdown-body .pl-4 {
  padding-left: 24px !important;
}

.markdown-body .pl-5 {
  padding-left: 32px !important;
}

.markdown-body .pl-6 {
  padding-left: 40px !important;
}

.markdown-body::before {
  display: table;
  content: "";
}

.markdown-body::after {
  display: table;
  clear: both;
  content: "";
}

.markdown-body>*:first-child {
  margin-top: 0 !important;
}

.markdown-body>*:last-child {
  margin-bottom: 0 !important;
}

.markdown-body a:not([href]) {
  color: inherit;
  text-decoration: none;
}

.markdown-body .anchor {
  float: left;
  padding-right: 4px;
  margin-left: -20px;
  line-height: 1;
}

.markdown-body .anchor:focus {
  outline: none;
}

.markdown-body p,
.markdown-body blockquote,
.markdown-body ul,
.markdown-body ol,
.markdown-body dl,
.markdown-body table,
.markdown-body pre {
  margin-top: 0;
  margin-bottom: 16px;
}

.markdown-body hr {
  height: 0.25em;
  padding: 0;
  margin: 24px 0;
  background-color: #e1e4e8;
  border: 0;
}

.markdown-body blockquote {
  padding: 0 1em;
  color: #6a737d;
  border-left: 0.25em solid #dfe2e5;
}

.markdown-body blockquote>:first-child {
  margin-top: 0;
}

.markdown-body blockquote>:last-child {
  margin-bottom: 0;
}

.markdown-body kbd {
  display: inline-block;
  padding: 3px 5px;
  font-size: 11px;
  line-height: 10px;
  color: #444d56;
  vertical-align: middle;
  background-color: #fafbfc;
  border: solid 1px #c6cbd1;
  border-bottom-color: #959da5;
  border-radius: 3px;
  box-shadow: inset 0 -1px 0 #959da5;
}

.markdown-body h1,
.markdown-body h2,
.markdown-body h3,
.markdown-body h4,
.markdown-body h5,
.markdown-body h6 {
  margin-top: 24px;
  margin-bottom: 16px;
  font-weight: 600;
  line-height: 1.25;
}

.markdown-body h1 .octicon-link,
.markdown-body h2 .octicon-link,
.markdown-body h3 .octicon-link,
.markdown-body h4 .octicon-link,
.markdown-body h5 .octicon-link,
.markdown-body h6 .octicon-link {
  color: #1b1f23;
  vertical-align: middle;
  visibility: hidden;
}

.markdown-body h1:hover .anchor,
.markdown-body h2:hover .anchor,
.markdown-body h3:hover .anchor,
.markdown-body h4:hover .anchor,
.markdown-body h5:hover .anchor,
.markdown-body h6:hover .anchor {
  text-decoration: none;
}

.markdown-body h1:hover .anchor .octicon-link,
.markdown-body h2:hover .anchor .octicon-link,
.markdown-body h3:hover .anchor .octicon-link,
.markdown-body h4:hover .anchor .octicon-link,
.markdown-body h5:hover .anchor .octicon-link,
.markdown-body h6:hover .anchor .octicon-link {
  visibility: visible;
}

.markdown-body h1 {
  padding-bottom: 0.3em;
  font-size: 2em;
  border-bottom: 1px solid #eaecef;
}

.markdown-body h2 {
  padding-bottom: 0.3em;
  font-size: 1.5em;
  border-bottom: 1px solid #eaecef;
}

.markdown-body h3 {
  font-size: 1.25em;
}

.markdown-body h4 {
  font-size: 1em;
}

.markdown-body h5 {
  font-size: 0.875em;
}

.markdown-body h6 {
  font-size: 0.85em;
  color: #6a737d;
}

.markdown-body ul,
.markdown-body ol {
  padding-left: 2em;
}

.markdown-body ul ul,
.markdown-body ul ol,
.markdown-body ol ol,
.markdown-body ol ul {
  margin-top: 0;
  margin-bottom: 0;
}

.markdown-body li {
  word-wrap: break-all;
}

.markdown-body li>p {
  margin-top: 16px;
}

.markdown-body li+li {
  margin-top: 0.25em;
}

.markdown-body dl {
  padding: 0;
}

.markdown-body dl dt {
  padding: 0;
  margin-top: 16px;
  font-size: 1em;
  font-style: italic;
  font-weight: 600;
}

.markdown-body dl dd {
  padding: 0 16px;
  margin-bottom: 16px;
}

.markdown-body table {
  display: block;
  width: 100%;
  overflow: auto;
}

.markdown-body table th {
  font-weight: 600;
}

.markdown-body table th,
.markdown-body table td {
  padding: 6px 13px;
  border: 1px solid #dfe2e5;
}

.markdown-body table tr {
  background-color: #fff;
  border-top: 1px solid #c6cbd1;
}

.markdown-body table tr:nth-child(2n) {
  background-color: #f6f8fa;
}

.markdown-body img {
  max-width: 100%;
  box-sizing: content-box;
  background-color: #fff;
}

.markdown-body img[align=right] {
  padding-left: 20px;
}

.markdown-body img[align=left] {
  padding-right: 20px;
}

.markdown-body code {
  padding: 0.2em 0.4em;
  margin: 0;
  font-size: 85%;
  background-color: rgba(27,31,35,0.05);
  border-radius: 3px;
}

.markdown-body pre {
  word-wrap: normal;
}

.markdown-body pre>code {
  padding: 0;
  margin: 0;
  font-size: 100%;
  word-break: normal;
  white-space: pre;
  background: transparent;
  border: 0;
}

.markdown-body .highlight {
  margin-bottom: 16px;
}

.markdown-body .highlight pre {
  margin-bottom: 0;
  word-break: normal;
}

.markdown-body .highlight pre,
.markdown-body pre {
  padding: 16px;
  overflow: auto;
  font-size: 85%;
  line-height: 1.45;
  background-color: #f6f8fa;
  border-radius: 3px;
}

.markdown-body pre code {
  display: inline;
  max-width: auto;
  padding: 0;
  margin: 0;
  overflow: visible;
  line-height: inherit;
  word-wrap: normal;
  background-color: transparent;
  border: 0;
}

.markdown-body .full-commit .btn-outline:not(:disabled):hover {
  color: #005cc5;
  border-color: #005cc5;
}

.markdown-body kbd {
  display: inline-block;
  padding: 3px 5px;
  font: 11px "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
  line-height: 10px;
  color: #444d56;
  vertical-align: middle;
  background-color: #fafbfc;
  border: solid 1px #d1d5da;
  border-bottom-color: #c6cbd1;
  border-radius: 3px;
  box-shadow: inset 0 -1px 0 #c6cbd1;
}

.markdown-body :checked+.radio-label {
  position: relative;
  z-index: 1;
  border-color: #0366d6;
}

.markdown-body .task-list-item {
  list-style-type: none;
}

.markdown-body .task-list-item+.task-list-item {
  margin-top: 3px;
}

.markdown-body .task-list-item input {
  margin: 0 0.2em 0.25em -1.6em;
  vertical-align: middle;
}

.markdown-body hr {
  border-bottom-color: #eee;
}

		</style>
		<title>compression-performance</title>
	</head>

	<body>
		<div class="top-bar">
	<svg style="position: absolute; padding: 2px 0 0 1px;" height="12px" width="16px" viewBox="2 2 13 12" version="1.1" aria-hidden="true"><path fill-rule="evenodd" d="M3 5h4v1H3V5zm0 3h4V7H3v1zm0 2h4V9H3v1zm11-5h-4v1h4V5zm0 2h-4v1h4V7zm0 2h-4v1h4V9zm2-6v9c0 .55-.45 1-1 1H9.5l-1 1-1-1H2c-.55 0-1-.45-1-1V3c0-.55.45-1 1-1h5.5l1 1 1-1H15c.55 0 1 .45 1 1zm-8 .5L7.5 3H2v9h6V3.5zm7-.5H9.5l-.5.5V12h6V3z"></path></svg>
	<div class="file-name">
		compression-performance
	</div>
</div>
<div class="markdown-body">

<h1>Description</h1>
<p>Files related to the &quot;Observing How Compression Affects Performance&quot; exercise.</p>
<h2 id="measuring-compression">Measuring Compression</h2>
<p>In this exercise, we will measure the following items:</p>
<ul>
<li><p>Compression ratio for our data. Which compression algorithm(s) provide the best compression for the data we're sending.</p></li>
<li><p>The rates at which producers can send our data. Does compression adversely affect message send rate, and if so, whether we can still handle the desired throughput.</p></li>
<li><p>Throughput for the Kafka brokers. Can we send more messages/sec bytes/sec using compression?</p></li>
<li><p>Topic Storage sizes: One of the main benefits of compression is decreased storage requirements, allowing retention of data for longer periods of time, more topics, etc.</p></li>
</ul>
<h2 id="review-the-code">Review the code</h2>
<p>Take a moment to look at the code. There are two Producer classes:</p>
<ul>
<li><code>src/main/java/com/cloudera/training/kafka/BaseStationImageProducer.java</code></li>
<li><code>src/main/java/com/cloudera/training/kafka/SimpleAsyncProducer.java</code></li>
</ul>
<p>In particular, note the <code>setupProperties</code> method of both producers. You might want to tweak the following settings:</p>
<ul>
<li><code>LINGER_MS_CONFIG</code></li>
<li><code>BATCH_SIZE_CONFIG</code></li>
</ul>
<p>These settings are described here: <a href="https://www.cloudera.com/documentation/kafka/latest/topics/kafka_performance.html#kafka_performance_tuning_producers">https://www.cloudera.com/documentation/kafka/latest/topics/kafka_performance.html#kafka_performance_tuning_producers</a></p>
<p><code>BaseStationImageProducer</code> retrieves minimally compressed JPEG images generated by another class. These images are approximately 100KB in size, and it takes approximately .25 seconds to generate each image</p>
<p><code>SimpleAsyncProducer</code> creates random strings of data. The sizes of the strings are adjustable.</p>
<p>You will use these two classes to send data to their respective KafkaTopics and measure the effects of compression.</p>
<h2 id="build-and-package-the-code">Build and Package the Code</h2>
<pre><code>mvn package
</code></pre>
<h2 id="create-the-topics">Create the Topics</h2>
<p>Run the commands below to create the topics. Make a note of these commands, because it will be useful to delete topics and recreate them when trying to compare different compression algorithms.</p>
<p>It's a bit easier to visualize performance results if you publish to a different topic each time. For example, creating a <code>randomstrings_gzip</code> topic to test gzip on our randomstrings data. It's up to you. Here's a shell script to create the topics:</p>
<pre><code>for comp in gzip lz4 snappy none;
do
    kafka-topics --zookeeper $ZK_CONNECT_STRING \
                 --delete \
                 --if-exists \
                 --topic images_${comp}

    kafka-topics --zookeeper $ZK_CONNECT_STRING \
                 --create \
                 --topic images_${comp} \
                 --partitions 1 \
                 --replication-factor 3

    kafka-topics --zookeeper $ZK_CONNECT_STRING \
                 --delete \
                 --if-exists \
                 --topic randomstrings_${comp}

    kafka-topics --zookeeper $ZK_CONNECT_STRING \
                 --create \
                 --topic randomstrings_${comp} \
                 --partitions 1 \
                 --replication-factor 3
done
</code></pre>
<h2 id="set-up-metrics-dashboard">Set up Metrics Dashboard</h2>
<p>Metrics can be gathered using many tools; in this exercise we will observe and gather metrics from multiple sources:</p>
<ol>
<li>Cloudera Manager</li>
<li>Metrics logs produced by the consumers and producers</li>
<li>Using Linux/Kafka commands</li>
</ol>
<p>There are quite a few Kafka charts available in Cloudera Manager. In this section we will create a dashboard for monitoring the respective topics.</p>
<p>We can point and click to charts, in Cloudera Manager (CM) but we can also use &quot;TSQuery&quot; which is a SQL-like language to create charts. In Cloudera Manager, use the &quot;Charts&quot; tab to create a dashboard.</p>
<p>After you've created the dashboard, add the following charts using TSQuery.</p>
<ul>
<li><p>Bytes Received for topics:</p>
<pre><code>SELECT total_kafka_bytes_received_rate_across_kafka_broker_topics 
WHERE category=KAFKA_TOPIC 
AND kafkaTopicName rlike &quot;randomstrings.*&quot; OR kafkaTopicName rlike &quot;images.*&quot;
</code></pre></li>
<li><p>Bytes Fetched for topics:</p></li>
</ul>
<pre><code>    SELECT kafka_bytes_fetched_rate_across_kafka_broker_topics 
    WHERE category=KAFKA_TOPIC
        AND kafkaTopicName rlike &quot;randomstrings.*&quot; OR kafkaTopicName rlike &quot;images.*&quot;
</code></pre>
<ul>
<li><p>Messages Received Rate</p>
<p>Recommend creating two charts, one for each topic:</p>
<pre><code>SELECT kafka_messages_received_rate_across_kafka_broker_topics 
WHERE kafkaTopicName rlike &quot;images.*&quot; or kafkaTopicName rlike &quot;randomstrings.*&quot;
</code></pre></li>
<li><p>Topic Size</p>
<pre><code>SELECT kafka_size_across_kafka_replicas 
WHERE category=KAFKA_TOPIC
AND (kafkaTopicName rlike &quot;randomstrings.*&quot; OR kafkaTopicName rlike &quot;images.*&quot;)
</code></pre></li>
</ul>
<h2 id="shortcut-for-running-all-four-compression-codecs">Shortcut for Running All Four Compression Codecs</h2>
<p>If running each test is too cumbersome, it is recommended to use this shortcut. Even if you do run this shortcut, please read the following sections in sequence to understand how to compare the metrics.</p>
<p>You could modify this shortcut to run all the codecs for the BaseStationImageProducer as well. Again, if you use this shortcut for the BaseStationImageProducer please read the sections below to see how to actually compare the metrics.</p>
<pre><code>for compression in gzip snappy none lz4; do
    mvn exec:java \
        -Dexec.mainClass=&quot;com.cloudera.training.kafka.SimpleAsyncProducer&quot; \
        -Dexec.args=&quot;$BOOTSTRAP_SERVERS randomstrings_$compression $compression 20000000&quot;

    mv producerMetrics.log rs${compression}ProducerMetrics.log
    cat headersCompression.tsv *ProducerMetrics.log &gt; producerMetrics.tsv
done
</code></pre>
<h2 id="copy-the-producermetrics.log-file-after-each-run">Copy the <code>producerMetrics.log</code> File After Each Run</h2>
<p><em>Important</em>: Since the <code>producerMetrics.log</code> file is overwritten on each run, you'll need to copy it to a new file after running the producer each time. For example:</p>
<pre><code>cp producerMetrics.log rsGzipProducerMetrics.log
</code></pre>
<h2 id="run-the-simpleasync-producer-and-record-the-metrics">Run the SimpleAsync Producer and Record the Metrics</h2>
<p>Producers should run for at least a few minutes. While producers are running, log into Cloudera Manager and monitor the dashboard you set up.</p>
<p>Specify the <code>none</code> compression type and the value <code>20000000</code> (20 million) on the first run.</p>
<p><em>Note</em> You may need to adjust how many records are sent.</p>
<pre><code>mvn exec:java \
    -Dexec.mainClass=&quot;com.cloudera.training.kafka.SimpleAsyncProducer&quot; \
    -Dexec.args=&quot;$BOOTSTRAP_SERVERS randomstrings_none none 20000000&quot;
</code></pre>
<p>Note the value of the <code>compression.type</code> property that is output when you start the Producer. This tells you which, if any, codec is used to compress the messages sent by the Producer.</p>
<p>As the program is running, log into Cloudera Manager, and note the metrics for the <em>specific topic</em> you're producing, in this case, <code>randomstrings</code>.</p>
<h2 id="copy-the-producermetrics.log-file">Copy the <code>producerMetrics.log</code> File</h2>
<p><em>Important</em>: Since the <code>producerMetrics.log</code> file is overwritten on each run, you'll need to copy it to a new file after running the producer each time. For example:</p>
<pre><code>cp producerMetrics.log rsNoneProducerMetrics.log
</code></pre>
<p>Also, it's worth noting the <code>Total time</code> that is printed out by Maven after running a producer:</p>
<pre><code>[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  01:02 min
...
[INFO] ------------------------------------------------------------------------
</code></pre>
<p>Remember to check the charts in Cloudera Manager after a run and note the metrics for this specific run.</p>
<h2 id="run-simpleasyncproducer-using-gzip">Run SimpleAsyncProducer using Gzip</h2>
<p>After the SimpleAsyncProducer has run using no compression, run the producer again, using the <code>gzip</code> compression, and rename the <code>producerMetrics.log</code> file to <code>rsGzipProducerMetrics.log</code></p>
<pre><code>mvn exec:java \
    -Dexec.mainClass=&quot;com.cloudera.training.kafka.SimpleAsyncProducer&quot; \
    -Dexec.args=&quot;$BOOTSTRAP_SERVERS randomstrings_gzip gzip 20000000&quot;
mv producerMetrics.log rsGzipProducerMetrics.log
</code></pre>
<h2 id="compare-metrics">Compare Metrics</h2>
<p>There are many metrics available. We recommend checking the following from the <code>rsNoneProducerMetrics.log</code> file using <code>grep</code> or a text editor:</p>
<ul>
<li><code>compression-rate-avg</code></li>
<li><code>batch-size-avg</code></li>
<li><code>record-send-rate</code></li>
<li><code>record-size</code></li>
<li><code>request-size-max</code></li>
<li><code>request-latency-avg</code></li>
<li><code>outgoing-byte-total</code></li>
<li><code>outgoing-byte-rate\\s</code></li>
</ul>
<p>Many of the metrics are described here:</p>
<ul>
<li><a href="https://kafka.apache.org/10/documentation.html#selector_monitoring">https://kafka.apache.org/10/documentation.html#selector_monitoring</a></li>
<li><a href="https://kafka.apache.org/10/documentation.html#producer_sender_monitoring">https://kafka.apache.org/10/documentation.html#producer_sender_monitoring</a></li>
</ul>
<p>Here's an example of comparing metrics from all <code>*ProducerMetrics.log files</code>:</p>
<pre><code># Record send rate and record size (to compare bytes sent)
grep -EiHn record-send-rate\|record-size\|outgoing-byte-rate\\s *ProducerMetrics.log | vim -

grep -iHn compression-rate-avg *ProducerMetrics.log
grep -iHn outgoing-byte-total *ProducerMetrics.log
grep -iHn outgoing-byte-rate\\s *ProducerMetrics.log
</code></pre>
<p>Note that some metrics have common prefixes (e.g. <code>outgoing-byte-total</code> and <code>outgoing-byte-totalnode--2</code>), so you might see more output than expected for certain metrics.</p>
<h2 id="using-charts-to-compare-metrics">Using Charts to Compare Metrics</h2>
<p>This course includes a Javascript charting library which can be used for easier viewing of compression metrics.</p>
<p>This is included in the file producerCompression.html.</p>
<p>To use producerCompression.html, there must be data in the file <code>producerMetrics.tsv</code>.</p>
<p>You can combine the output of each compression log into producerMetrics.tsv and the charts will be updated. If you ran the shortcut, this has been done for you.</p>
<p>The producerMetrics.tsv must have a header, which is included in headersCompression.tsv.</p>
<p>Combine all *log files and headersCompression into a single file:</p>
<p><code>cat headersCompression.tsv *ProducerMetrics.log &gt; producerMetrics.tsv</code></p>
<p>Open the producerCompression.html file for a set of charts showing the performance characteristics of each compression type. You can run the above <code>cat</code> command after each test of compression codecs and data types, and then refresh the producerMetrics.html file.</p>
<h2 id="choose-another-compression-codec">Choose Another Compression Codec</h2>
<p>You may repeat the above run using <code>SimpleAsyncProducer</code>, specifying a different compression codec. Kafka supports two other compression codecs <code>lz4</code> and <code>snappy</code>. Remember to change the codec specification when running the producer:</p>
<pre><code>mvn exec:java \
    -Dexec.mainClass=&quot;com.cloudera.training.kafka.SimpleAsyncProducer&quot; \
    -Dexec.args=&quot;$BOOTSTRAP_SERVERS randomstrings_snappy snappy 20000000&quot;
mv producerMetrics.log rsSnappyProducerMetrics.log
</code></pre>
<p>Remember to copy/move the producerMetrics.log file after running and compare producer side metrics (See <a href="#Compare-Metrics">Compare Metrics</a> above)</p>
<pre><code>grep -iHn compression-rate-avg *.log
</code></pre>
<h2 id="using-basestationimageproducer-data">Using BaseStationImageProducer Data</h2>
<p>Now, we will use a different producer, the <code>BaseStationImageProducer</code> which produces images at a slower rate than the <code>SimpleAsyncProducer</code>.</p>
<pre><code>mvn exec:java \
    -Dexec.mainClass=&quot;com.cloudera.training.kafka.BaseStationImageProducer&quot; \
    -Dexec.args=&quot;$BOOTSTRAP_SERVERS images_none none 2000&quot;

mv producerMetrics.log imagesNoneProducerMetrics.log
</code></pre>
<pre><code>mvn exec:java \
    -Dexec.mainClass=&quot;com.cloudera.training.kafka.BaseStationImageProducer&quot; \
    -Dexec.args=&quot;$BOOTSTRAP_SERVERS images_gzip gzip 2000&quot;

mv producerMetrics.log imagesGzipProducerMetrics.log
</code></pre>
<pre><code>mvn exec:java \
    -Dexec.mainClass=&quot;com.cloudera.training.kafka.BaseStationImageProducer&quot; \
    -Dexec.args=&quot;$BOOTSTRAP_SERVERS images_snappy snappy 2000&quot;

mv producerMetrics.log imagesSnappyProducerMetrics.log
</code></pre>
<pre><code>mvn exec:java \
    -Dexec.mainClass=&quot;com.cloudera.training.kafka.BaseStationImageProducer&quot; \
    -Dexec.args=&quot;$BOOTSTRAP_SERVERS images_lz4 lz4 2000&quot;

mv producerMetrics.log imagesLz4ProducerMetrics.log
</code></pre>
<h2 id="bonus:-viewing-kafka-storage-of-compressed-messages">Bonus: Viewing Kafka Storage of Compressed Messages</h2>
<p>Kafka stores compressed messages using &quot;wrapper&quot; or &quot;batch&quot; messages. This is described (in text) here: <a href="https://kafka.apache.org/10/documentation.html#messageformat">https://kafka.apache.org/10/documentation.html#messageformat</a></p>
<p>You can view those &quot;wrapper&quot; messages using Kafka's <code>DumpLogSegment</code> tool.</p>
<p>Using SSH, connect to one of the kafka brokers storing the contents of the <code>images</code> or <code>randomstrings</code> topics, find the directory containing the messages, and use the <code>dumpLogSegment</code> tool to view the messages.</p>
<p>We recommend viewing log segments from topics that have compressed messages.</p>
<pre><code>    ssh &lt;a broker&gt;
    cd /var/local/kafka/data/randomstrings_snappy-0

    kafka-run-class kafka.tools.DumpLogSegments --files *.log
</code></pre>
<p>You can get an idea of the compression ratio for the messages by looking at the output of the <code>DumpLogSegments</code> tool.</p>
<p>Example output (wrapped):</p>
<pre><code>baseOffset: 0 lastOffset: 1466 baseSequence: -1 lastSequence: -1 producerId: -1
producerEpoch: -1 partitionLeaderEpoch: 0 isTransactional: false position: 0
CreateTime: 1544825199294 isvalid: true size: 21857 magic: 2 compresscodec:
SNAPPY crc: 2121194149

baseOffset: 1467 lastOffset: 2936 baseSequence: -1 lastSequence: -1 producerId:
-1 producerEpoch: -1 partitionLeaderEpoch: 0 isTransactional: false position:
21857 CreateTime: 1544825199327 isvalid: true size: 21340 magic: 2
compresscodec: SNAPPY crc: 2116468157

baseOffset: 2937 lastOffset: 4406 baseSequence: -1 lastSequence: -1 producerId:
-1 producerEpoch: -1 partitionLeaderEpoch: 0 isTransactional: false position:
43197 CreateTime: 1544825199351 isvalid: true size: 21253 magic: 2
compresscodec: SNAPPY crc: 1657521359
</code></pre>
<p>Using the --deep-iteration switch will show the offsets of the individidual messages</p>
<p><code>kafka-run-class kafka.tools.DumpLogSegments --deep-iteration --files *.log</code></p>
<p>Of course, we can view the disk usage of the topic/partition:</p>
<p><code>du -h .</code></p>
<h2 id="run-the-consumers-and-gather-metrics">Run the Consumers and Gather Metrics</h2>
<p>For each message type and codec you ran the producers for, run a corresponding consumer.</p>
<ul>
<li><p>Consumers read all messages from the starting offset.</p></li>
<li><p>The consumers do not join a specific consumer group, to allow &quot;re-runs&quot; without needing to explicitly seek to the beginning offset for the same consumer group.</p></li>
<li><p>Consumers also output a metrics file called <code>consumerMetrics.log</code>.</p></li>
<li><p>Remember to copy the <code>consumerMetrics.log</code> to a type/codec log file after each consumer run.</p></li>
<li><p>After each run, view the chart corresonding to &quot;Bytes Fetched for topics&quot; in Cloudera Manager.</p></li>
</ul>
<p>Some examples:</p>
<h3 id="images-with-no-compression">Images with No Compression</h3>
<pre><code>mvn exec:java \
    -Dexec.mainClass=&quot;com.cloudera.training.kafka.BaseStationImageConsumer&quot; \
    -Dexec.args=&quot;$BOOTSTRAP_SERVERS images_none 2000&quot;

mv consumerMetrics.log imagesNoneConsumerMetrics.log
</code></pre>
<h3 id="images-with-gzip-compression">Images with Gzip Compression</h3>
<pre><code>mvn exec:java \
    -Dexec.mainClass=&quot;com.cloudera.training.kafka.BaseStationImageConsumer&quot; \
    -Dexec.args=&quot;$BOOTSTRAP_SERVERS images_gzip 2000&quot;

mv consumerMetrics.log imagesGzipConsumerMetrics.log
</code></pre>
<h2 id="compare-consumer-metrics-for-different-compression-types">Compare Consumer Metrics for Different Compression Types</h2>
<p>View the log files produced by the above instances of each consumer run.</p>

		</div>
	</body>
</html>
